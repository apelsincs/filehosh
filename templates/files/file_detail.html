{% extends 'base.html' %}

{% block title %}{{ file.filename }} - 0123.ru{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- File Info Card -->
            <div class="card shadow-lg border-0 mb-4 file-info-card">
                <div class="card-header bg-gradient-primary text-white text-center py-4">
                    <div class="d-flex align-items-center justify-content-center">
                        <div class="file-icon-large me-3">
                            <i class="{{ file.get_file_type_icon }}"></i>
                        </div>
                        <div>
                            <h3 class="mb-1">{{ file.filename }}</h3>
                            <p class="mb-0 opacity-75">{{ file.get_file_type_name }}</p>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- File Details -->
                            <div class="file-details-grid mb-4">
                                <div class="detail-card">
                                    <div class="detail-icon">
                                        <i class="fas fa-hashtag"></i>
                                    </div>
                                    <div class="detail-content">
                                        <div class="detail-label">–ö–æ–¥ —Ñ–∞–π–ª–∞</div>
                                        <div class="detail-value fw-bold text-primary">{{ file.code }}</div>
                                    </div>
                                </div>
                                
                                <div class="detail-card">
                                    <div class="detail-icon">
                                        <i class="{{ file.get_file_type_icon }}"></i>
                                    </div>
                                    <div class="detail-content">
                                        <div class="detail-label">–¢–∏–ø —Ñ–∞–π–ª–∞</div>
                                        <div class="detail-value {{ file.get_file_type_color }}">{{ file.get_file_type_name }}</div>
                                    </div>
                                </div>
                                
                                <div class="detail-card">
                                    <div class="detail-icon">
                                        <i class="fas fa-weight-hanging"></i>
                                    </div>
                                    <div class="detail-content">
                                        <div class="detail-label">–†–∞–∑–º–µ—Ä</div>
                                        <div class="detail-value">{{ file.get_file_size_mb }} –ú–ë</div>
                                    </div>
                                </div>
                                
                                <div class="detail-card">
                                    <div class="detail-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="detail-content">
                                        <div class="detail-label">–ó–∞–≥—Ä—É–∂–µ–Ω</div>
                                        <div class="detail-value">{{ file.created_at|date:"d.m.Y H:i" }}</div>
                                    </div>
                                </div>
                                
                                <div class="detail-card">
                                    <div class="detail-icon">
                                        <i class="fas fa-hourglass-half"></i>
                                    </div>
                                    <div class="detail-content">
                                        <div class="detail-label">–ò—Å—Ç–µ–∫–∞–µ—Ç</div>
                                        <div class="detail-value {% if file.is_expired %}text-danger{% endif %}">
                                            {{ file.expires_at|date:"d.m.Y H:i" }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="detail-card">
                                    <div class="detail-icon">
                                        <i class="fas fa-download"></i>
                                    </div>
                                    <div class="detail-content">
                                        <div class="detail-label">–°–∫–∞—á–∏–≤–∞–Ω–∏–π</div>
                                        <div class="detail-value">{{ file.download_count }}</div>
                                    </div>
                                </div>
                                
                                <div class="detail-card">
                                    <div class="detail-icon">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <div class="detail-content">
                                        <div class="detail-label">–ó–∞—â–∏—Ç–∞</div>
                                        <div class="detail-value">
                                            {% if file.is_protected %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-lock me-1"></i>–ü–∞—Ä–æ–ª—å
                                                </span>
                                            {% else %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-unlock me-1"></i>–û—Ç–∫—Ä—ã—Ç—ã–π
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="action-buttons">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <a href="{% url 'files:download_file' file.code %}" 
                                           class="btn btn-primary btn-lg w-100">
                                            <i class="fas fa-download me-2"></i>
                                            –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                                        </a>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <a href="{% url 'files:edit_file' file.code %}" 
                                           class="btn btn-outline-secondary btn-lg w-100">
                                            <i class="fas fa-edit me-2"></i>
                                            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                        </a>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <button class="btn btn-outline-info btn-lg w-100 copy-link-btn" 
                                             data-url="{{ file_url }}">
                                            <i class="fas fa-link me-2"></i>
                                            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                                        </button>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <a href="{% url 'files:delete_file' file.code %}" 
                                           class="btn btn-outline-danger btn-lg w-100">
                                            <i class="fas fa-trash me-2"></i>
                                            –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- QR Code -->
                            <div class="qr-code-section text-center">
                                <h5 class="mb-3">
                                    <i class="fas fa-qrcode me-2"></i>
                                    QR –∫–æ–¥
                                </h5>
                                {% if file.qr_code %}
                                    <div class="qr-code-container mb-3">
                                        <img src="{{ file.qr_code.url }}" 
                                             alt="QR –∫–æ–¥ –¥–ª—è —Ñ–∞–π–ª–∞ {{ file.code }}" 
                                             class="img-fluid border rounded">
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="window.downloadQRCode(document.querySelector('.qr-code-container img'))">
                                            <i class="fas fa-download me-1"></i>
                                            –°–∫–∞—á–∞—Ç—å QR –∫–æ–¥
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary copy-link-btn" type="button"
                                                data-url="{{ file_url }}">
                                            <i class="fas fa-share me-1"></i>
                                            –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                                        </button>
                                    </div>
                                {% else %}
                                    <div class="qr-code-placeholder p-4 border rounded">
                                        <i class="fas fa-qrcode fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">QR –∫–æ–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File URL Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-link me-2"></i>
                        –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª
                    </h5>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" class="form-control" value="{{ file_url }}" 
                               id="fileUrl" readonly>
                        <button class="btn btn-outline-primary copy-link-btn" type="button" 
                                 data-url="{{ file_url }}">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="form-text mt-2">
                        <i class="fas fa-info-circle me-1"></i>
                        –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–æ–π —Å—Å—ã–ª–∫–æ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É
                    </div>
                </div>
            </div>

            <!-- Time Remaining Card -->
            <div class="card shadow-sm border-0" id="time-remaining-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-hourglass-half me-2"></i>
                        –û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è
                    </h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="time-remaining-progress" class="progress-bar bg-warning" style="width: 75%"></div>
                    </div>
                    <p class="text-muted mb-0">
                        <i class="fas fa-clock me-1"></i>
                        –§–∞–π–ª –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω {{ file.expires_at|date:"d.m.Y –≤ H:i" }}
                    </p>
                </div>
            </div>
            
            <!-- –¢–µ—Å—Ç–æ–≤–∞—è —Å–µ–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
            <div class="card shadow-sm border-0 mt-3" style="display: none;" id="debug-card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-bug me-2"></i>
                        –û—Ç–ª–∞–¥–∫–∞
                    </h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-sm btn-warning" onclick="alert('JavaScript —Ä–∞–±–æ—Ç–∞–µ—Ç!')">
                        üß™ –¢–µ—Å—Ç JavaScript
                    </button>
                    <button class="btn btn-sm btn-info" onclick="console.log('–ö–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', document.querySelectorAll('.copy-link-btn').length)">
                        üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–Ω–æ–ø–∫–∏
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// –ü—Ä–æ—Å—Ç–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è...');
    
    const copyButtons = document.querySelectorAll('.copy-link-btn');
    console.log('–ù–∞–π–¥–µ–Ω–æ –∫–Ω–æ–ø–æ–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', copyButtons.length);
    
    copyButtons.forEach((button, index) => {
        const url = button.getAttribute('data-url');
        console.log(`–ö–Ω–æ–ø–∫–∞ ${index + 1}:`, url);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
        button.addEventListener('click', (e) => {
            console.log(`–ö–Ω–æ–ø–∫–∞ ${index + 1} –Ω–∞–∂–∞—Ç–∞!`);
            console.log('URL –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', url);
            
            if (url && url.trim() !== '') {
                // –ü—Ä–æ–±—É–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
                if (typeof copyToClipboard === 'function') {
                    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º copyToClipboard');
                    copyToClipboard(url, button);
                } else {
                    console.log('copyToClipboard –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
                    // Fallback –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(url).then(() => {
                            console.log('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ Clipboard API');
                            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                        }).catch((error) => {
                            console.error('–û—à–∏–±–∫–∞ Clipboard API:', error);
                            alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message);
                        });
                    } else {
                        console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º execCommand fallback');
                        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                        const textArea = document.createElement('textarea');
                        textArea.value = url;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        try {
                            const successful = document.execCommand('copy');
                            if (successful) {
                                console.log('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ execCommand');
                                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
                            } else {
                                console.error('execCommand –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª');
                                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
                            }
                        } catch (err) {
                            console.error('–û—à–∏–±–∫–∞ execCommand:', err);
                            alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + err.message);
                        }
                        
                        document.body.removeChild(textArea);
                    }
                }
            } else {
                console.error('URL –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                alert('–û—à–∏–±–∫–∞: —Å—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            }
        });
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    console.log('copyToClipboard –¥–æ—Å—Ç—É–ø–Ω–∞:', typeof copyToClipboard !== 'undefined');
    console.log('showNotification –¥–æ—Å—Ç—É–ø–Ω–∞:', typeof showNotification !== 'undefined');
    console.log('setupGlobalCopyButtons –¥–æ—Å—Ç—É–ø–Ω–∞:', typeof setupGlobalCopyButtons !== 'undefined');
});

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é —Å–µ–∫—Ü–∏—é –ø–æ –Ω–∞–∂–∞—Ç–∏—é Ctrl+Shift+D
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        const debugCard = document.getElementById('debug-card');
        if (debugCard) {
            debugCard.style.display = debugCard.style.display === 'none' ? 'block' : 'none';
        }
    }
});

// Live update remaining time progress
document.addEventListener('DOMContentLoaded', () => {
    const progress = document.getElementById('time-remaining-progress');
    if (!progress) return;
    const createdAt = new Date('{{ file.created_at|date:"c" }}').getTime();
    const expiresAt = new Date('{{ file.expires_at|date:"c" }}').getTime();
    const total = expiresAt - createdAt;
    const update = () => {
        const now = Date.now();
        const remaining = Math.max(0, expiresAt - now);
        const percent = Math.max(0, Math.min(100, (remaining / total) * 100));
        progress.style.width = `${percent}%`;
        progress.textContent = remaining <= 0 ? '–§–∞–π–ª –∏—Å—Ç–µ–∫' : (window.Utils ? window.Utils.formatTimeRemaining('{{ file.expires_at|date:"c" }}') : '');
        progress.setAttribute('aria-valuemin', '0');
        progress.setAttribute('aria-valuemax', '100');
        progress.setAttribute('aria-valuenow', String(Math.round(percent)));
        progress.setAttribute('role', 'progressbar');
        if (remaining <= 0) {
            progress.classList.remove('bg-warning');
            progress.classList.add('bg-danger');
        }
    };
    update();
    setInterval(update, 60000);
});
</script>
{% endblock %} 